<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIS Web Application - Kimathi Joram</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <style>
        /* General styling */
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #e9ecef;
            overflow: hidden;
        }

        #main-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* Sidebar */
        #sidebar {
            width: 400px;
            background-color: #ffffff;
            border-right: 2px solid #ced4da;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 3px 0 8px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        #map {
            flex-grow: 1;
            height: 100%;
        }

        .sidebar-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .sidebar-section h3 {
            font-size: 1.25rem;
            margin-bottom: 15px;
            color: #343a40;
            font-weight: 600;
        }

        /* Layer item */
        .layer-item {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }

        .layer-item:hover {
            background-color: #f1f3f5;
        }

        .layer-item input[type="checkbox"] {
            margin-right: 12px;
        }

        .layer-item .color-box {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            border: 1px solid #adb5bd;
            border-radius: 4px;
        }

        .layer-item .color-picker {
            margin-right: 12px;
            width: 30px;
            height: 30px;
            border: none;
            cursor: pointer;
        }

        .layer-item label {
            flex-grow: 1;
            font-size: 0.95rem;
            color: #495057;
        }

        .layer-item .action-button, .layer-item .delete-button {
            margin: 4px;
            padding: 6px 12px;
            font-size: 0.85rem;
            border-radius: 6px;
        }

        /* Upload forms */
        #upload-form, #raster-upload-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        #upload-form input, #raster-upload-form input {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        #upload-form button, #raster-upload-form button {
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        #upload-form button:hover, #raster-upload-form button:hover {
            background-color: #0056b3;
        }

        /* Attribute table */
        #attribute-table-container {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            border-radius: 6px;
        }

        #attribute-table {
            width: 100%;
            border-collapse: collapse;
        }

        #attribute-table th, #attribute-table td {
            border: 1px solid #dee2e6;
            padding: 10px;
            font-size: 0.9rem;
            color: #495057;
        }

        #attribute-table th {
            background-color: #e9ecef;
            font-weight: 600;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            overflow: auto;
        }

        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .modal-body {
            padding: 20px 0;
        }

        .modal-footer {
            padding-top: 10px;
            border-top: 1px solid #dee2e6;
        }

        .close {
            color: #6c757d;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close:hover {
            color: #343a40;
        }

        /* Raster transparency slider */
        .transparency-slider {
            width: 100%;
            margin: 10px 0;
        }

        /* Buttons */
        .action-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        .action-button:hover {
            background-color: #218838;
        }

        .delete-button {
            background-color: #dc3545;
        }

        .delete-button:hover {
            background-color: #c82333;
        }

        /* Status messages */
        #status-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            display: none;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Feature popup */
        #feature-popup .modal-content {
            max-width: 450px;
        }

        #feature-popup table {
            width: 100%;
            border-collapse: collapse;
        }

        #feature-popup th, #feature-popup td {
            border: 1px solid #dee2e6;
            padding: 10px;
            font-size: 0.85rem;
        }

        #feature-popup th {
            background-color: #e9ecef;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            #sidebar {
                width: 100%;
                height: 45%;
                position: fixed;
                bottom: 0;
                z-index: 2000;
                transition: transform 0.3s ease-in-out;
                background-color: #fff;
            }

            #map {
                height: 55%;
            }

            .sidebar-hidden {
                transform: translateY(100%);
            }

            .layer-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .layer-item .action-button, .layer-item .delete-button {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div id="main-container">
        <div id="sidebar">
            <div class="sidebar-section">
                <h3>Vector Layers</h3>
                <div id="vector-layers"></div>
            </div>
            <div class="sidebar-section">
                <h3>Raster Layers</h3>
                <div id="raster-layers"></div>
            </div>
            <div class="sidebar-section">
                <h3>Upload Vector Layer</h3>
                <form id="upload-form">
                    <input type="text" id="vector-table-name" placeholder="Enter table name" required>
                    <input type="file" id="vector-file" accept=".zip" required>
                    <button type="submit">Upload Vector</button>
                </form>
            </div>
            <div class="sidebar-section">
                <h3>Upload Raster Layer</h3>
                <form id="raster-upload-form">
                    <input type="text" id="raster-table-name" placeholder="Enter table name" required>
                    <input type="file" id="raster-file" accept=".zip" required>
                    <button type="submit">Upload Raster</button>
                </form>
            </div>
            <div class="sidebar-section">
                <h3>Layer Actions</h3>
                <button class="action-button" onclick="openCreateLayerModal()">Create New Layer</button>
                <button class="action-button" onclick="downloadSelected()">Download Selected</button>
                <button class="action-button" onclick="mergeFeatures()">Merge Selected Features</button>
            </div>
            <div class="sidebar-section">
                <h3>Attribute Table</h3>
                <select id="layer-select" onchange="loadAttributes()">
                    <option value="">Select a layer</option>
                </select>
                <div id="attribute-table-container"></div>
            </div>
            <div id="status-message"></div>
        </div>
        <div id="map"></div>
    </div>

    <div id="create-layer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeCreateLayerModal()">&times;</span>
                <h2>Create New Layer</h2>
            </div>
            <div class="modal-body">
                <form id="create-layer-form">
                    <label for="source-table">Source Layer:</label>
                    <select id="source-table" required></select>
                    <label for="new-table-name">New Table Name:</label>
                    <input type="text" id="new-table-name" required>
                    <button type="submit" class="action-button">Create Layer</button>
                </form>
            </div>
        </div>
    </div>

    <div id="merge-features-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeMergeFeaturesModal()">&times;</span>
                <h2>Merge Selected Features</h2>
            </div>
            <div class="modal-body">
                <form id="merge-features-form">
                    <label for="merge-source-table">Source Layer:</label>
                    <select id="merge-source-table" required></select>
                    <label for="merge-table-name">New Table Name:</label>
                    <input type="text" id="merge-table-name" required>
                    <button type="submit" class="action-button">Merge Features</button>
                </form>
            </div>
        </div>
    </div>

    <div id="feature-popup" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeFeaturePopup()">&times;</span>
                <h2>Feature Attributes</h2>
            </div>
            <div class="modal-body">
                <div id="feature-attributes"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script>
        const map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            maxZoom: 18
        }).addTo(map);

        let vectorLayers = {};
        let rasterLayers = {};
        let currentLayers = {};
        let selectedFeatures = {};
        let rasterTransparency = {};

        function fetchVectorLayers() {
            fetch('/spatial_tables')
                .then(response => response.json())
                .then(data => {
                    vectorLayers = data;
                    const vectorContainer = document.getElementById('vector-layers');
                    const layerSelect = document.getElementById('source-table');
                    const mergeLayerSelect = document.getElementById('merge-source-table');
                    const attributeSelect = document.getElementById('layer-select');
                    vectorContainer.innerHTML = '';
                    layerSelect.innerHTML = '<option value="">Select a layer</option>';
                    mergeLayerSelect.innerHTML = '<option value="">Select a layer</option>';
                    attributeSelect.innerHTML = '<option value="">Select a layer</option>';

                    Object.keys(data).forEach(table => {
                        fetch(`/get_color/${table}`)
                            .then(response => response.json())
                            .then(colorData => {
                                const layer = data[table];
                                layer.color = colorData.color;
                                const layerItem = document.createElement('div');
                                layerItem.className = 'layer-item';
                                layerItem.innerHTML = `
                                    <input type="checkbox" id="${table}" onchange="toggleVectorLayer('${table}')">
                                    <div class="color-box" style="background-color: ${layer.color}"></div>
                                    <label for="${table}">${layer.title}</label>
                                    <input type="color" class="color-picker" id="color_${table}" value="${layer.color}" onchange="changeLayerColor('${table}')">
                                    <button class="action-button" onclick="zoomToLayer('${table}')">Zoom</button>
                                    <button class="action-button" onclick="downloadLayer('${table}')">Download</button>
                                    <button class="delete-button" onclick="deleteLayer('${table}')">Delete</button>
                                `;
                                vectorContainer.appendChild(layerItem);
                                const option = document.createElement('option');
                                option.value = table;
                                option.textContent = layer.title;
                                layerSelect.appendChild(option);
                                mergeLayerSelect.appendChild(option.cloneNode(true));
                                attributeSelect.appendChild(option.cloneNode(true));
                                if (currentLayers[table]) {
                                    updateLayerStyle(table);
                                }
                            });
                    });
                })
                .catch(error => showStatus(`Error fetching vector layers: ${error}`, 'error'));
        }

        function fetchRasterLayers() {
            fetch('/raster_tables')
                .then(response => response.json())
                .then(data => {
                    rasterLayers = data;
                    const rasterContainer = document.getElementById('raster-layers');
                    rasterContainer.innerHTML = '';

                    data.forEach(tableData => {
                        const table = tableData.table_name;
                        rasterTransparency[table] = rasterTransparency[table] || 1.0;
                        const layerItem = document.createElement('div');
                        layerItem.className = 'layer-item';
                        layerItem.innerHTML = `
                            <input type="checkbox" id="raster_${table}" onchange="toggleRasterLayer('${table}')">
                            <label for="raster_${table}">${table}</label>
                            <input type="range" class="transparency-slider" id="transparency_${table}" min="0" max="1" step="0.1" value="${rasterTransparency[table]}" onchange="updateRasterTransparency('${table}')">
                            <button class="action-button" onclick="downloadRasterLayer('${table}')">Download</button>
                        `;
                        rasterContainer.appendChild(layerItem);
                    });
                })
                .catch(error => showStatus(`Error fetching raster layers: ${error}`, 'error'));
        }

        function toggleVectorLayer(table) {
            if (currentLayers[table]) {
                map.removeLayer(currentLayers[table]);
                delete currentLayers[table];
                delete selectedFeatures[table];
            } else {
                fetch(`/data/${table}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            showStatus(data.error, 'error');
                            return;
                        }
                        const layer = L.geoJSON(data, {
                            style: feature => ({
                                color: vectorLayers[table].color,
                                weight: 2,
                                opacity: 0.8,
                                fillOpacity: 0.4
                            }),
                            pointToLayer: (feature, latlng) => {
                                return L.circleMarker(latlng, {
                                    radius: 6,
                                    color: vectorLayers[table].color,
                                    fillOpacity: 0.8
                                });
                            },
                            onEachFeature: (feature, layer) => {
                                layer.on('click', () => {
                                    const rowid = feature.properties._rowid;
                                    if (!selectedFeatures[table]) selectedFeatures[table] = [];
                                    const index = selectedFeatures[table].indexOf(rowid);
                                    if (index === -1) {
                                        selectedFeatures[table].push(rowid);
                                        layer.setStyle({ fillOpacity: 0.9, weight: 3 });
                                    } else {
                                        selectedFeatures[table].splice(index, 1);
                                        layer.setStyle({ fillOpacity: 0.4, weight: 2 });
                                    }
                                    showFeaturePopup(table, feature.properties);
                                    updateAttributeTable();
                                });
                            }
                        }).addTo(map);
                        currentLayers[table] = layer;
                        map.fitBounds(layer.getBounds());
                    })
                    .catch(error => showStatus(`Error loading layer ${table}: ${error}`, 'error'));
            }
        }

        function toggleRasterLayer(table) {
            if (currentLayers[table]) {
                Object.values(currentLayers[table]).forEach(layer => map.removeLayer(layer));
                delete currentLayers[table];
            } else {
                currentLayers[table] = {};
                fetch(`/raster_tables`)
                    .then(response => response.json())
                    .then(data => {
                        const tableData = data.find(d => d.table_name === table);
                        if (!tableData) return;
                        tableData.rasters.forEach(raster => {
                            fetch(`/raster_preview/${table}/${raster.rid}`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.error) {
                                        showStatus(data.error, 'error');
                                        return;
                                    }
                                    const bounds = [[data.bounds[0][0], data.bounds[0][1]], [data.bounds[1][0], data.bounds[1][1]]];
                                    const layer = L.imageOverlay(`data:image/png;base64,${data.image}`, bounds, {
                                        opacity: rasterTransparency[table]
                                    }).addTo(map);
                                    currentLayers[table][raster.rid] = layer;
                                    map.fitBounds(bounds);
                                });
                        });
                    })
                    .catch(error => showStatus(`Error loading raster ${table}: ${error}`, 'error'));
            }
        }

        function updateRasterTransparency(table) {
            const slider = document.getElementById(`transparency_${table}`);
            rasterTransparency[table] = parseFloat(slider.value);
            if (currentLayers[table]) {
                Object.values(currentLayers[table]).forEach(layer => {
                    layer.setOpacity(rasterTransparency[table]);
                });
            }
        }

        function changeLayerColor(table) {
            const colorPicker = document.getElementById(`color_${table}`);
            const color = colorPicker.value;
            fetch(`/set_color/${table}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ color })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        vectorLayers[table].color = color;
                        document.querySelector(`#${table}_color`).style.backgroundColor = color;
                        updateLayerStyle(table);
                        showStatus(data.success, 'success');
                    } else {
                        showStatus(data.error, 'error');
                    }
                })
                .catch(error => showStatus(`Error changing color: ${error}`, 'error'));
        }

        function updateLayerStyle(table) {
            if (currentLayers[table]) {
                currentLayers[table].eachLayer(layer => {
                    const rowid = layer.feature.properties._rowid;
                    const isSelected = selectedFeatures[table] && selectedFeatures[table].includes(rowid);
                    layer.setStyle({
                        color: vectorLayers[table].color,
                        weight: isSelected ? 3 : 2,
                        opacity: 0.8,
                        fillOpacity: isSelected ? 0.9 : 0.4
                    });
                });
            }
        }

        function zoomToLayer(table) {
            if (currentLayers[table]) {
                map.fitBounds(currentLayers[table].getBounds());
            } else {
                showStatus('Layer not loaded. Please enable the layer first.', 'error');
            }
        }

        function downloadLayer(table) {
            fetch(`/download_layer/${table}`)
                .then(response => {
                    if (!response.ok) throw new Error('Download failed');
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${table}.zip`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => showStatus(`Error downloading layer: ${error}`, 'error'));
        }

        function downloadRasterLayer(table) {
            fetch(`/download_raster/${table}`)
                .then(response => {
                    if (!response.ok) throw new Error('Download failed');
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${table}.zip`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => showStatus(`Error downloading raster layer: ${error}`, 'error'));
        }

        function showFeaturePopup(table, properties) {
            const container = document.getElementById('feature-attributes');
            let html = '<table><tr><th>Attribute</th><th>Value</th></tr>';
            for (const [key, value] of Object.entries(properties)) {
                html += `<tr><td>${key}</td><td>${value}</td></tr>`;
            }
            html += '</table>';
            container.innerHTML = html;
            document.getElementById('feature-popup').style.display = 'block';
        }

        function closeFeaturePopup() {
            document.getElementById('feature-popup').style.display = 'none';
        }

        function loadAttributes() {
            const table = document.getElementById('layer-select').value;
            if (!table) {
                document.getElementById('attribute-table-container').innerHTML = '';
                return;
            }
            fetch(`/attributes/${table}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showStatus(data.error, 'error');
                        return;
                    }
                    const container = document.getElementById('attribute-table-container');
                    container.innerHTML = '<table id="attribute-table" class="table table-striped"></table>';
                    const tableElement = document.getElementById('attribute-table');
                    let columns = data.columns.map(col => ({ title: col, data: col }));
                    $(tableElement).DataTable({
                        data: data.rows,
                        columns: columns,
                        pageLength: 10,
                        lengthMenu: [5, 10, 25, 50],
                        select: {
                            style: 'multi',
                            selector: 'td:first-child'
                        },
                        columnDefs: [{
                            targets: 0,
                            data: '_rowid',
                            render: (data, type, row) => {
                                const isSelected = selectedFeatures[table] && selectedFeatures[table].includes(data);
                                return `<input type="checkbox" class="row-select" data-rowid="${data}" ${isSelected ? 'checked' : ''}>`;
                            }
                        }]
                    });

                    $(tableElement).on('click', '.row-select', function() {
                        const rowid = parseInt(this.dataset.rowid);
                        if (!selectedFeatures[table]) selectedFeatures[table] = [];
                        const index = selectedFeatures[table].indexOf(rowid);
                        if (this.checked && index === -1) {
                            selectedFeatures[table].push(rowid);
                        } else if (!this.checked && index !== -1) {
                            selectedFeatures[table].splice(index, 1);
                        }
                        updateMapSelection(table);
                    });
                })
                .catch(error => showStatus(`Error loading attributes: ${error}`, 'error'));
        }

        function updateMapSelection(table) {
            if (currentLayers[table]) {
                currentLayers[table].eachLayer(layer => {
                    const rowid = layer.feature.properties._rowid;
                    if (selectedFeatures[table] && selectedFeatures[table].includes(rowid)) {
                        layer.setStyle({ fillOpacity: 0.9, weight: 3 });
                    } else {
                        layer.setStyle({ fillOpacity: 0.4, weight: 2 });
                    }
                });
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('status-message');
            status.textContent = message;
            status.className = type;
            status.style.display = 'block';
            setTimeout(() => status.style.display = 'none', 5000);
        }

        document.getElementById('upload-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('vector-file');
            const tableName = document.getElementById('vector-table-name').value;
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('tablename', tableName);

            fetch('/upload_vector', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus(data.success, 'success');
                        fetchVectorLayers();
                    } else {
                        showStatus(data.error, 'error');
                    }
                })
                .catch(error => showStatus(`Error uploading vector: ${error}`, 'error'));
        });

        document.getElementById('raster-upload-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('raster-file');
            const tableName = document.getElementById('raster-table-name').value;
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('tablename', tableName);

            fetch('/upload_raster', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus(data.success, 'success');
                        fetchRasterLayers();
                    } else {
                        showStatus(data.error, 'error');
                    }
                })
                .catch(error => showStatus(`Error uploading raster: ${error}`, 'error'));
        });

        function deleteLayer(table) {
            if (confirm(`Are you sure you want to delete ${table}?`)) {
                fetch(`/delete/${table}`, {
                    method: 'POST'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showStatus(data.success, 'success');
                            if (currentLayers[table]) {
                                map.removeLayer(currentLayers[table]);
                                delete currentLayers[table];
                                delete selectedFeatures[table];
                            }
                            fetchVectorLayers();
                        } else {
                            showStatus(data.error, 'error');
                        }
                    })
                    .catch(error => showStatus(`Error deleting layer: ${error}`, 'error'));
            }
        }

        function downloadSelected() {
            const layersWithSelection = Object.keys(selectedFeatures).filter(table => selectedFeatures[table] && selectedFeatures[table].length > 0);
            if (layersWithSelection.length !== 1) {
                showStatus('Please select features from exactly one layer.', 'error');
                return;
            }
            const table = layersWithSelection[0];
            fetch('/download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ layer: table, selected: selectedFeatures[table] })
            })
                .then(response => {
                    if (!response.ok) throw new Error('Download failed');
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${table}_selection.zip`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => showStatus(`Error downloading: ${error}`, 'error'));
        }

        function mergeFeatures() {
            const layersWithSelection = Object.keys(selectedFeatures).filter(table => selectedFeatures[table] && selectedFeatures[table].length > 0);
            if (layersWithSelection.length !== 1) {
                showStatus('Please select features from exactly one layer.', 'error');
                return;
            }
            document.getElementById('merge-source-table').value = layersWithSelection[0];
            document.getElementById('merge-features-modal').style.display = 'block';
        }

        function closeMergeFeaturesModal() {
            document.getElementById('merge-features-modal').style.display = 'none';
        }

        document.getElementById('merge-features-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const table = document.getElementById('merge-source-table').value;
            const newTable = document.getElementById('merge-table-name').value;
            const rowids = selectedFeatures[table] || [];

            if (!table || !newTable || rowids.length < 2) {
                showStatus('Please select a layer, enter a new table name, and select at least two features.', 'error');
                return;
            }

            fetch('/merge_features', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ table, new_table: newTable, rowids })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus(data.success, 'success');
                        fetchVectorLayers();
                        closeMergeFeaturesModal();
                    } else {
                        showStatus(data.error, 'error');
                    }
                })
                .catch(error => showStatus(`Error merging features: ${error}`, 'error'));
        });

        function openCreateLayerModal() {
            document.getElementById('create-layer-modal').style.display = 'block';
        }

        function closeCreateLayerModal() {
            document.getElementById('create-layer-modal').style.display = 'none';
        }

        document.getElementById('create-layer-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const sourceTable = document.getElementById('source-table').value;
            const newTable = document.getElementById('new-table-name').value;
            const rowids = selectedFeatures[sourceTable] || [];

            if (!sourceTable || !newTable || rowids.length === 0) {
                showStatus('Please select a source layer, enter a new table name, and select features.', 'error');
                return;
            }

            fetch('/create_layer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ source_table: sourceTable, new_table: newTable, rowids })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus(data.success, 'success');
                        fetchVectorLayers();
                        closeCreateLayerModal();
                    } else {
                        showStatus(data.error, 'error');
                    }
                })
                .catch(error => showStatus(`Error creating layer: ${error}`, 'error'));
        });

        document.addEventListener('DOMContentLoaded', () => {
            fetchVectorLayers();
            fetchRasterLayers();
            showStatus('Welcome, Kimathi Joram (celestakim018@gmail.com), GIS & RS enthusiast at DeKUT!', 'success');
        });
    </script>
</body>
</html>
